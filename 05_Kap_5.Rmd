# Er dataene dine normalfordelte?

I forrige kapittel viste vi til at data har ulike fordelinger, og at ulike analyser vi gjør i statistisk prosesskontroll har forutsetninger/bygger på antalkelser om hvordan dataene er fordelt (det gjelder forsåvidt alle statistiske analyser vi gjør). Så i dette kapittelet skal vi se nærmere på hvordan vi kan avgjøre om dataene våre er normalfordelte - i mange tilfeller vil det være hensiktsmessig å først sjekke for normalitet siden veldig mange statistiske analyser forutsetter det ^[Det er tildels stor uenighet om hvor alvorlig avvik fra normalfordelingens teoretiske forventning man kan være for likevel å bruke ulike statistiske analyser. Mange analyser er ganske robuste for avvik. Det beste rådet tror vi er å være bevisst på dette og sjekke med statistikkbøker og artikler hvor robuste de enkelte analysene er for avvik]. Vi skal også være klar over at utregning av såkalte testverdier (som Shapiro-Wilk eller Anderson-Darling) også bygger på visse forutsetninger. Vi har imidlertid en metode som vi kan kalle forutsetningsfri som vi anbefaler å begynne med: Q-Q plott.

## Q-Q plott

Både histogrammet og Q-Q plottet er visuelle måter å undersøke om en distribusjon er normalfordelt eller ikke. Selv om de ikke alltid gir et entydig svar er de egnet til å gi oss et inntrykk av om en datadistribusjon er normalfordelt eller ikke. Setter man en normalfordelingskurve på et histogram gir det en indikasjon. Som hjelpemiddel er imidlertid Q-Q plott langt bedre.

Q-Q plottet ("quantile-quantile plot") kan tolkes ved å se om dataverdiene ligger langs en rett linje med ca 45 graders vinkel. Q-Q plottet (se video for forklaring på utregning) innebærer å se to distribusjoner mot hverandre – empirisk fordeling (dataene) og teoretisk forventning ut fra en fordelingsmodell (som normalfordeling om vi snakker om "normal Q-Q plott - dvs vi ser om vår empiriske datafordeling og normalfordelingen er lik). Om de samsvarer perfekt ligger de på en helt rett linje (x = y). I eksempelet under vil da alle punktene ligge perfekt oppå den rette linjen. Siden vi vet den teoretiske distribusjonen til normalfordelingen, kan vi bruke denne teoretiske fordelingen til å plotte den mot datasettet vi sitter med.  

Vi har laget en video som viser hvordan du kan lage et Q-Q plott "fra scratch" i [Excel](https://vimeo.com/625625741). Statistikkprogrammer (som R og evt statistikk/SPC plug-ins i Excel) lager naturligvis dette (og regner ut testverdier) svært raskt og enkelt for oss.

La oss først se på et Q-Q plott som viser en normalfordeling (du kan laste ned Excelfila hvis du ønsker dataene):

```{r echo=FALSE, eval=TRUE}

pacman::p_load(tidyverse, ggplot2, writexl)

# Lage normalfordelt datasett

set.seed(89)

qqnorm <- rnorm(10000, mean=90, sd=5)

qqnorm <- as_tibble(qqnorm)

# Eksporter som Excel

write_xlsx(qqnorm,"QQ_norm.xlsx")
```

```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_norm.xlsx')
```

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott normalfordeling"}

pacman::p_load(ggplot2, tidyverse, readxl, ggpubr)

qqnorm_plott <- ggplot(qqnorm, aes(sample = value)) +
  stat_qq() +
  stat_qq_line()

print(qqnorm_plott + ggtitle("Normal Q-Q plott") + labs(x = "Teoretisk forventning", y = "Data"))

```

Vi ser at dette Q-Q plottet viser oss at vi kan være ganske sikre på at dette datasettet er normalfordelt (noe som gir meninig siden vi har brukt R til å lage et normalfordelt datasett).

Tolkning av Q-Q plott er imidlertid ikke alltid så enkelt som i eksempelet ovenfor - det er en viss grad av subjektivitet involvert. Underhar vi gjengitt noen typiske mønstre vi kan se og hva de skyldes. Som et supplement til Q-Q plott kan vi bruke ulike testverdier (fra f.eks. Shapiro-Wilk og Anderson-Darling). Disse kommer vi tilbake til senere i kapittelet.

I det første eksempelet på avvik fra den helt klare normalfordelingen lager vi et datasett som har en skjevhet mot høyre ("right skewness") - også kalt positiv skjevhet (uten at det legges noe "positivt" i positivt). Datasettet kan lastes ned i Excelformat her:

```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_norm_rs.xlsx')
```

```{r  echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott - fordeling skjevhet høyre"}

pacman::p_load(gridExtra, writexl, ggplot2, tidyverse)

# Lage datasett med right skew

set.seed(90)

N <- 5000
qqrightskew <- rnbinom(N, 10, .1)
 
qqrightskew <- as_tibble(qqrightskew)

# Eksportere datasettet

write_xlsx(qqrightskew,"QQ_norm_rs.xlsx")

# Plotte histogram og Q-Q plott"

qqrighthist <- ggplot(qqrightskew, aes(x=value)) + geom_histogram(color="black", fill="lightblue")

qqrightskew_plott <- ggplot(qqrightskew, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle("Normal Q-Q plott - skjevhet høyre") + labs(x = "Teoretisk forventning", y = "Data")

grid.arrange(qqrighthist, qqrightskew_plott, ncol=2)

```

I et datasett med høyreskjevhet vil ofte Q-Q plottet vise en bananform med "bunnen"/midten av bananen ned mot høyre hjørne og endene pekende oppover/utover fra den rette linjen.

I det neste datasettet har vi generert en kraftig skjevhet til venstre. Q-Q plottet får da en omvendt bananform i forhold til høyre skjevhet, altså en topp på midten og to ender som svinger nedover ift den rette linja. Datasettet finner du her:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_norm_ls.xlsx')
```


```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott - fordeling skjevhet venstre"}

pacman::p_load(gridExtra, writexl, ggplot2, tidyverse)

# Lage datasett med left skew

set.seed(91)

N=5000
qqleftskew <- rbeta(N,5,1,ncp=0)

qqleftskew <- as_tibble(qqleftskew)

# Eksportere datasettet

write_xlsx(qqleftskew,"QQ_norm_ls.xlsx")

# Plotte histogram og Q-Q plott

qqlefthist <- ggplot(qqleftskew, aes(x=value)) + geom_histogram(color="black", fill="lightblue")

qqleftskew_plott <- ggplot(qqleftskew, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle("Normal Q-Q plott - skjevhet venstre") + labs(x = "Teoretisk forventning", y = "Data")

grid.arrange(qqlefthist, qqleftskew_plott, ncol=2)

```

De neste to tilfellene av avvik vi skal ta for oss er såkalte "light-tailed" (lette haler med liten sannsynlighet for ekstreme verdier og utvalg tendeerer til å ikke fravike gjennomsnittet med mye) og "heavy-tailed" (fete/tunge haler med større sannsynlighet for at ekstreme verdier vil forekomme) fordelinger. Datasett for fete haler er her:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_ht.xlsx')
```


```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott - 'heavy-tail'"}

pacman::p_load(gridExtra, writexl, ggplot2, tidyverse, LambertW)

set.seed(92)

qqflat <- rLambertW(n=100, distname = "normal", beta = c(0,1), delta = 0.5)

qqflat <- as_tibble(qqflat)

# Eksportere datasettet

write_xlsx(qqflat,"QQ_flat.xlsx")

# Plotte histogram og Q-Q plott

qqflathist <- ggplot(qqflat, aes(x=value)) + geom_histogram(color="black", fill="lightblue")

qqflat_plott <- ggplot(qqflat, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle("Normal Q-Q plott - heavy-tail") + labs(x = "Teoretisk forventning", y = "Data")

grid.arrange(qqflathist, qqflat_plott, ncol=2)

```
Fordelinger med tunge haler vil ofte følge en slags omvendt S-form. Den starter med å vokse raskere enn normalfordelingen og ender med å vokse saktere. 

Datasettet for lette haler finner du her:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_lt.xlsx')
```


```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott - 'light-tail'"}

pacman::p_load(gridExtra, writexl, ggplot2, tidyverse)

set.seed(81)

qqlt <- runif(n = 1000, min = -1, max = 1)

qqlt <- as_tibble(qqlt)

# Eksportere datasettet

write_xlsx(qqlt,"QQ_lt.xlsx")

# Plotte histogram og Q-Q plott

qqlthist <- ggplot(qqlt, aes(x=value)) + geom_histogram(color="black", fill="lightblue")

qqlt_plott <- ggplot(qqlt, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle(" Normal Q-Q plott - light-tail") + labs(x = "Teoretisk forventning", y = "Data")

grid.arrange(qqlthist, qqlt_plott, ncol=2)

```
Q-Q plottet for en fordeling med lette haler har ofte en S-form. Dataene vokser saktere enn normalfordelingen i starten før den følger vekstraten til normalfordelingen. Mot slutten vokser den raskere enn normalfordelingen. Derfor bøyer den av fra normalfordelingen.

Til slutt kan vi se på en typisk bimodial fordeling, med datasett her:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('QQ_bimod.xlsx')
```

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Q-Q plott - bimodial"}

pacman::p_load(gridExtra, writexl, ggplot2, tidyverse)

set.seed(10) 

mode1 <- rnorm(50,2,1)
mode1 <- mode1[mode1 > 0] 
mode2 <- rnorm(50,6,1)
mode2 <- mode2[mode2 > 0] 
qqbimod <- as_tibble(sort(c(mode1,mode2)))

# Eksportere datasettet

write_xlsx(qqbimod,"QQ_bimod.xlsx")

# Plotte histogram og Q-Q plott

qqbimodhist <- ggplot(qqbimod, aes(x=value)) + geom_histogram(color="black", fill="lightblue")

qqbimod_plott <- ggplot(qqbimod, aes(sample = value)) +
  stat_qq() +
  stat_qq_line() +
  ggtitle(" Normal Q-Q plott - bimodial") + labs(x = "Teoretisk forventning", y = "Data")

grid.arrange(qqbimodhist, qqbimod_plott, ncol=2)

```
Den bimodiale fordelingen viser ofte et brudd eller et distinkt knekkpunkt rundt krysning av den rette linja, med en del av linja på hver side av den rette linja. 

Vi har nå sett på noen typiske eksempler på mønstre i Q-Q plott. Det kan imidlertid være vanskelig å bedømme fordelinger som ligger nære normalfordelingen, men likevel ikke perfekt oppå (du vil trolig aldri se en perfekt match med mindre du har generert et normalfordelt datasett med mange datapunkter). Vi kan supplere Q-Q plottene med visse statistiske tester - det er tema for de neste delkapitlene (men husk: disse statistiske testene har sine egne forutsetninger og er heller ikke uten utfordringer).

## Anderson-Darling test for normalitet




