# Kontrolldiagram

Et kontrolldiagram er mer sensitivt for å vise spesielle typer variasjon enn et run diagram. For å oppnå denne økte sensitiviteten er det imidlertid viktig at man velger riktig type kontrolldiagram ut fra hvilken type data man har. Her vil flytdiagrammet på s.xxxx kunne være til hjelp for å velge riktig type, men vi vil også gå gjennom hvert enkelt kontrolldiagram nedenfor. Man skal imidlertid ikke anta at et seriediagram er «mindre verdt» enn et kontrolldiagram. Selv om kontrolldiagram er mer sensitive ovenfor spesielle typer variasjon, er seriediagram mer sensitive ovenfor mindre skifter i dataene (under 2 SD) enn kontrolldiagrammene som typisk reagerer på større skifter i dataene (rundt 2 SD og mer) [@anhojRunChartsRevisited2014]. Et seriediagram kan derfor ofte være et viktig første steg før man tar i bruk mer sofistikerte verktøy som kontrolldiagram [@Perla2011].

En spesiell egenskap ved kontrolldiagram er at den kan hjelpe oss til å se yteevnen til en stabil prosess. Med det mener vi hvilke grenser prosessen trolig vil holde seg innenfor. Dette kalles ofte for prosesskapabilitet. Dette vil vi komme nærmere tilbake til i et senere avsnitt.

Så hva er et kontrolldiagram? Et kontrolldiagram er en statistisk tilnærming til å se på prosesser, variasjon i prosesser og om prosesser produserer resultater innenfor gitte akseptable grenser. Det likner på i stor grad på et seriediagram. Vi plotter inn en rekke hendelser eller observasjoner i et diagram der tiden for observasjonene plottes fortløpende i tid på x-aksen og verdien eller antall hendelser på y-aksen. Det et kontrolldiagram tilfører er at det inkluderer mer avanserte analyser gjennom å regne ut to kontrollgrenser som lar oss vurdere statistisk etter andre regler enn seriediagrammet om en prosess har normal eller unormal variasjon. I tillegg er kontrolldiagrammene basert på at sentraltendensen er gjennomsnittet, ikke median (som i seriediagrammet). 

Shewhart baserte sin tilnærming til kontrolldiagram på matematisk teori (se vedlegg 7 for forklaring på Chebyshevs teorem) og egne empiriske erfaringer når han satt verdiene for øvre og nedre kontrollgrenser til tre sigma (tre standardavvik). Flere tiårs erfaring fra en lang rekke områder viser at tre sigma som grenseverdier holder vann [@Mohammed2008].

Et kontrolldiagram kan se slik ut (R pakken *qicharts2* [@anhojQicharts2QualityImprovement2020]:
```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Eksempel kontrolldiagram i *qicharts*"}

pacman::p_load(qicharts2, qcc, tidyverse, gridExtra)

set.seed(81)

kontr_eks <- (rnorm(24))

kontr1 <- qic(kontr_eks, chart = 'i', title = "Eksempel på kontrolldiagram", subtitle = "Tilfeldig genererte tall", ylab = "Verdi", xlab = "Hendelse") 

kontr1 + geom_point(size = 2)

```
Observasjonene/målingene plottes som punkter sekvensielt i tid. Snittet er -0,2, UCL 2,2 og LCL -2,7.


Tilsvarende data ved bruk av R pakken *qcc* [@Scrucca2017]:
```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Eksempel kontrolldiagram i *qcc*", results='hide',fig.keep='all'}

pacman::p_load(qicharts2, tidyverse)

set.seed(81)

kontr_eks <- (rnorm(24))

kontr_eks <- as_tibble(kontr_eks)

kontr2 <- qcc(kontr_eks, type = "xbar.one", nsigmas = 3, title = "Eksempel på kontrolldiagram - Tilfeldig genererte tall", ylab = "Verdi", xlab = "Hendelse")

kontr2

```

Alle kontrolldiagram vil ha tre horisontale linjer: En gjennomsnittsverdi, en øvre kontrollgrense og en nedre kontrollgrense (øvre og nedre kontrollgrense kan ved enkelte typer kontrolldiagram avvike fra en ren horisontal linje, men ha et horisontalt mønster.

Ulike programmer eller R-pakker gir ulik grafisk framstilling.Analyse-It i Excel gir dette for samme data:

![](Eks_kontrdiagr.png)

Vi skal også være oppmerksom på at de kan opererer med ulike "regler" for når de flagger unormal variasjon. Ulike programmer kan imidlertid ha lagt inn noe ulike regler for hva som betraktes som unormal variasjon. Det er derfor lurt å sette seg inn i hvilke regler som benyttes i det programmet du bruker – alle programmene vil, på en eller annen måte, indikere unormal variasjon hvis vi ber programmet om å gjøre det. Og de fleste programmene vil også la oss velge mellom hvilke kontrollregler vi ønsker å bruke. Her må man altså sjekke opp ut fra hvilket program/R-pakke man ønsker å bruke. I det videre vil vi i hovedsak bruke *qcc* og *qicharts2*. Ulike sett regler har vokst fram fra det som regnes som de opprinnelige 4 reglene (1, 2, 5 og 6) [@WesternElectricCompany1956], til @Nelson1984 8 regler som er modifisert av flere, blant annet @Montgomery2020 (som *qicharts2* bruker).Pakken *qcc* bruker reglene 1, 2, 3 og 4 som "Shewhart reglene". 

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Oversikt regler kontrolldiagram"}

pacman::p_load(flextable, magrittr)

set_flextable_defaults(fonts_ignore=TRUE)

kontrdiagr_regler <- data.frame(Test = c("1","2", "3", "4", "5", "6", "7", "8"),
                            Regel = c("1 punkt utenfor kontrollgrensene", "2 av 3 påfølgende punkter er mer enn 2 sigma fra gjennomsnittsverdien og i samme retning", "4 av 5 påfølgende punkter er mer enn 1 sigma fra gjennomsnittsverdien og i samme retning", "8 påfølgende punkter er på samme side av gjennomsnittet", "6 påfølgende punkter er i stigende eller synkende trend (etter hverandre)", "15 påfølgende punkter er innenfor +/- 1 sigma fra gjennomsnittet", "14 påfølgende punkter alternerer opp og ned (annenhver opp og ned i forhold til foregående verdi)", "8 påfølgende punkter på samme side av gjennomsnittet og ingen innenfor +/- 1 sigma"),
                            Indikasjon = c("En større endring", "En mindre, men vedvarende endring", "En mindre, men vedvarende endring", "Ikke-tilfeldig systematisk variasjon", "En middels endring", "En liten endring", "Stratifisering (at vi egentlig har to eller flere prosesser – et histogram vil f.eks. kunne vise en bimodal distribusjon)", "Blandet variasjon"))

kontrdiagr_regler <- flextable(kontrdiagr_regler)

set_table_properties(kontrdiagr_regler, width = 1, layout = "autofit")
```

Bruk av regel 1 på en normalfordelte data vil kunne gi «falsk alarm» (vise unormal variasjon når det ikke finnes) i 1 av 370 tilfeller i gjennomsnitt. Hvis man imidlertid legger til testene 2, 5 og 6 stiger raten av feil alarmer til 1 av 91,75 tilfeller. Et godt råd som ofte gis er å velge tester før man lage kontrolldiagrammene basert på kjennskap til prosessen man holder på med. Som @anhojControlChartsQicharts2021 påpeker: "It is a common misunderstanding that control charts are superior to run charts. The confusion may stem from the fact that different sets of rules for identifying non-random variation in run charts are available, and that these sets differ significantly in their diagnostic properties." 

Eksempel på kontrolldiagram med indikasjon på et eller flere brudd på regler for normal variasjon:

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "Oversikt regler kontrolldiagram"}

set.seed(64)

mode1x <- rnorm(15,2,1)
mode1x <- mode1x[mode1x > 0] 
mode2x <- rnorm(15,3,2)
mode2x <- mode2x[mode2x > 0] 
kontr_eks2 <- (sort(c(mode1x,mode2x)))

kontr2 <- qic(kontr_eks2, chart = 'i', title = "Eksempel på kontrolldiagram", subtitle = "Tilfeldig genererte tall", ylab = "Verdi", xlab = "Hendelse")

kontr2

summary(kontr2)

```

Vi skal i videre i dette kapittelet ta for oss ulike typer kontrolldiagrammene (ref. flytskjema for valg av kontrolldiagram). Vi vil vise et eksempel på hvert av de vanlige kontrolldiagrammene. For hvert eksempel finnes det en Excelfil med dataene som er brukt for de ulike eksemplene og en video som viser framgangsmåten i Excel. Grunnen til dette er at for mange vil Excel være et mye mer kjent grensesnitt enn R. Samtidig, ved å se på videoen og stegene som gjøres, ser man hvordan det enkelte kontrolldiagram er bygd opp. Selvsagt er dette mye mer tidkrevende enn å bare kjøre analysen i R, men det kan gi en fin innsikt i "hva som egentlig skjer". På sikt mener vi det er mye å hente på å bruke R og pakken *qicharts2* eller pakken *qcc*. Alternativt kan man investere i et tillegg til Excel som nevnt i kapittel 1. 

## Telledata (attributter)
Diagrammene i dette delkapittelet handler om data der vi kan telle og putte dataene inn i kategorier. Motsetningen er måledata som er kontinuerlige data som behandles i neste delkapittel. 

### p-diagram

P-diagrammet er trolig det mest brukte diagrammet i helsesektoren [@anhojControlChartsQicharts2021]. Her er dataene binomiale, dvs type ja/nei. Vi kan f.eks. registrere om det er eller ikke er et avvik fra en gitt rutine. P-diagrammet og NP-diagrammet skiller seg kun fra hverandre ved at NP-diagrammet forutsetter en lik størrelse på utvalget hver måling, mens P-diagrammet brukes når utvalgsstørrelsen varierer. Hvis vi f.eks. registrerer antall avvik i en rutine pr uke og antallet gjennomføringer av rutinen varierer fra uke til uke bør vi bruke et P-diagram.

La oss tenke oss at vi har følgende data som viser antall keisersnitt og totalt antall fødsler på et sykehus [eksempeldata modifisert fra @qimacrosSixSigmaSPC2021].

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p-diagram data"}

pacman::p_load(flextable, magrittr)

set_flextable_defaults(fonts_ignore=TRUE)

pdiagr_data <- data.frame(Måned = c("Jan", "Feb", "Mar", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Des"),
                            Keisersnitt = c("65", "64", "77", "59", "64", "74", "72", "67", "59", "65", "60", "68"),
                            Fødsler = c("370", "383", "446", "454", "463", "431", "443", "451", "433", "407", "381", "406"),
                          Måned. = c("Jan", "Feb", "Mar", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Des"),
                          Keisersnitt. = c("62", "48", "57", "64", "66", "55", "51", "82", "65", "69", "62", "66"),
                          Fødsler. = c("374", "355", "393", "417", "434", "421", "417", "444", "429", "411", "386", "357"))

pdiagr_data <- flextable(pdiagr_data)

pdiagr_data <- add_header_row(pdiagr_data,
  colwidths = c(3, 3),
  values = c("År 1", "År 2"))

pdiagr_data <- align(pdiagr_data, align = "center", part = "all")

set_table_properties(pdiagr_data, width = 1, layout = "autofit")

```

Datasettet i Excelformat finner du her:

```{r echo=FALSE, eval=TRUE}

xfun::embed_file('P_chart.xlsx')
```

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p-diagram"}

pacman::p_load(qcc, tidyverse, readxl)

pdiagr <- as_tibble(read_excel("P_chart.xlsx"))

p_chart <- with(pdiagr, qcc(pdiagr$Keisersnitt, pdiagr$Antall_fødsler, type = "p", title = "p-diagram: Andel keisersnitt", xlab = "Måned", ylab = "Andel"))

```

I p-diagrammet vil UCL og LCL variere noe siden det tas hensyn til at n varierer fra registrering til registrering.

Video med framgangsmåte i Excel ligger [her](https://vimeo.com/621730851).

### Laney's p-diagram

I noen tilfeller har vi data som gir svært smale kontrollgrenser [eksempeldata modifisert fra @SPCforExcel2021].

La oss anta følgende datasett:

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p'-diagram data"}

pacman::p_load(flextable, magrittr)

set_flextable_defaults(fonts_ignore=TRUE)

Lpdiagr_data <- data.frame(Måned = c("Jan07", "Feb07", "Mar07", "Apr07", "Mai07", "Jun07", "Jul07", "Aug07"),
                            Medlemmer = c("8755", "9800", "17000", "16400", "19500", "19800", "21200", "22300"),
                            Pr_telefon = c("3852", "4100", "7083", "7339", "9406", "9310", "7250", "10400"),
                          Måned. = c("Sep07", "Okt07", "Nov07", "Des07", "Jan08", "Feb08", "Mar08", "Apr08"),
                          Medlemmer. = c("21600", "20500", "18700", "18900", "14300", "14800", "14500", "14600"),
                          Pr_telefon. = c("9250", "9950", "9846", "9854", "8034", "8162", "8122", "8200"))

Lpdiagr_data <- flextable(Lpdiagr_data)

Lpdiagr_data <- align(Lpdiagr_data, align = "center", part = "all")

set_table_properties(Lpdiagr_data, width = 1, layout = "autofit")

```

Datasett: 
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('Laneyp.xlsx')
```


```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p-diagram for Laney"}

pacman::p_load(qcc, tidyverse, readxl)

Lpdiagr <- as_tibble(read_excel("Laneyp.xlsx"))

Lp_chart <- with(Lpdiagr, qcc(Lpdiagr$Pr_telefon, Lpdiagr$Medlemmer, type = "p", title = "p-diagram: Andel kommunisert pr telefon", xlab = "Måned", ylab = "Andel"))

```

Diagrammet gir liten mening når mer eller mindre alle punktene ligger utenfor kontrollgrensene. @Laney2002 peker på at p- og u-diagrammer har forutsetninger om distribusjonen som blant annet antar at gjennomsnittet er konstant over tid. Kombinert med veldig stor utvalgsstørrelse gir dette såkalt overdispersjon, hvilket betyr at den faktiske variansen er større enn det modellen benytter. Framgangsmåten Laney foreslår kan virke noe teknisk, men innebærer å regne ut z verdien for alle punktene (z verdien forteller antallet standardavvik mellom det målte punktet og gjennomsnittet). Z-verdiene brukes så for å regne ut Moving Range (MR), som igjen brukes til å regne ut gjennomsnittlige MR, som igjen brukes til å regne ut UCL og LCL. 

Vi har laget en video som kort forklarer begrepet [Moving Range](https://vimeo.com/626416062). 

Som dere vil se i videoen (se lenke litt lenger ned) er den eneste forskjellen i formlene som regner ut UCL og LCL et uttrykk for standardavviket for z-verdiene. Denne, sier Laney, korrigerer for den relative andelen av prosessvariasjon som ikke forklares av den binomiale fordelingen alene. Ved stor n minskes variasjonen fra utvalgene. 

![](Laneyp.png)

Laneys p’-diagram er i realiteten veldig likt et I-diagram, med den forskjellen at p’-diagrammet tar høyde for varierende utvalgsstørrelser. Du finner en video som forklarer framgangsmåten i Excel [her](https://vimeo.com/622718116).

### np-diagram

Forskjellen på p-diagram og np-diagram ligger i om utvalgsstørrelsen er lik eller ulik gjennom registreringene. I dette eksempelet sjekker vi om en prosedyre er korrekt gjennomført eller ikke. For å registrere dette tar vi hver uke 50 stikkprøver og registrerer hvor mange som ikke er gjennomført iht prosedyren [eksempeldata modifisert fra @qimacrosSixSigmaSPC2021].

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p'-diagram data"}

pacman::p_load(flextable, magrittr)

set_flextable_defaults(fonts_ignore=TRUE)

npdiagr_data <- data.frame(Uke = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12"),
                            n = c("50","50","50","50","50","50","50","50","50","50","50","50"),
                            Feil = c("12", "15", "8", "10", "4", "7", "16", "9", "14", "10", "5", "6"),
                          Uke. = c("13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "23", "24"),
                          n. = c("50","50","50","50","50","50","50","50","50","50","50","50"),
                          Feil. = c("17", "12", "22", "8", "10", "5", "13", "11", "20", "18", "24", "15"))

npdiagr_data <- flextable(npdiagr_data)

npdiagr_data <- align(npdiagr_data, align = "center", part = "all")

set_table_properties(npdiagr_data, width = 1, layout = "autofit")

```

Datasett:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('np_diagram.xlsx')
```

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "np-diagram"}

pacman::p_load(qcc, tidyverse, readxl)

npdiagr <- as_tibble(read_excel("np_diagram.xlsx"))

np_chart <- with(npdiagr, qcc(npdiagr$Feil, npdiagr$n, type = "np", title = "np-diagram: Andel feil", xlab = "Uke", ylab = "Andel"))

```

I dette tilfellet ser vi at det ved to anledninger – uke 15 og 23 – var brudd på regel 1 (utenfor 3 sigma). 

Som vanlig finnes det en [Excelvideo](https://vimeo.com/623445363) som viser framgangsmåten steg-for-steg i Excel.

### u-diagram

p- og np-diagrammer teller antall defekter – en hendelse, et produkt, en tjeneste er enten defekt eller ikke. Men i mange tilfeller gir det ikke så mye mening å se på defekt/ikke-defekt. En bil kan f.eks. ha flere feil, men likevel være kjørbar. Bilen er ikke defekt selv om den har feil vi er interessert i. Det vi i stedet kan være mer interessert i er hvor mange feil har enheten vi ser på. Vi kan f.eks. være interessert i hvor mange kundeklager som har kommet inn i en periode. Vi er da interessert i antallet klager og antar ikke at hele prosessen er defekt selv om vi har klager. 

I eksempelet under ser vi på antall pasientfall opp mot totalt antall pasientdager [eksempeldata modifisert fra @qimacrosSixSigmaSPC2021].

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "p'-diagram data"}

pacman::p_load(flextable, magrittr)

set_flextable_defaults(fonts_ignore=TRUE)

udiagr_data <- data.frame(Måned = c("Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Des", "Jan", "Feb", "Mar", "Apr", "Mai"),
                            Pasientfall = c("17", "22", "23", "30", "28", "18", "44", "42", "33", "33", "33", "27"),
                            Pasientdager = c("4658", "4909", "4886", "4970", "4780", "4973", "5762", "5441", "5893", "5743", "4747", "5118"),
                          Måned. = c("Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Des", "Jan", "Feb", "Mar", "Apr", "Mai"),
                          n. = c("42", "41", "24", "22", "50", "51", "39", "22", "31", "33", "25", "22"),
                          Feil. = c("5609", "5722", "5261", "6071", "6072", "5335", "6483", "5752", "5731", "5017", "5158", "5040"))

udiagr_data <- flextable(udiagr_data)

udiagr_data <- align(udiagr_data, align = "center", part = "all")

set_table_properties(udiagr_data, width = 1, layout = "autofit")

```

Datasett:
```{r echo=FALSE, eval=TRUE}

xfun::embed_file('u_diagram.xlsx')
```

```{r echo = FALSE, message = FALSE, warning=FALSE, fig.cap = "up-diagram"}

pacman::p_load(qcc, tidyverse, readxl)

udiagr <- as_tibble(read_excel("u_diagram.xlsx"))

u_chart <- with(udiagr, qcc(udiagr$Pasientfall, udiagr$Pasientdager, type = "u", title = "u-diagram: Andel feil", xlab = "Uke", ylab = "Pasientfall"))

```

Video her for [Excel](https://vimeo.com/623605142)

